from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import httpx, os, re

router = APIRouter(prefix="/tx", tags=["tx-send"])

RPC = os.getenv("BSC_RPC", "https://bsc-dataseed.binance.org/")
ALLOW_TO = set(a.lower() for a in os.getenv("TX_ALLOW_TO", "").split(",") if a.strip())
if not ALLOW_TO:
    ALLOW_TO.add("0xacb0a09414cea1c879c67bb7a877e4e19480f022")

def _is_hexhash(s: str) -> bool:
    return bool(re.fullmatch(r"0x[0-9a-fA-F]{64}", s or ""))

async def _rpc(method: str, params, idv: int = 1):
    payload = {"jsonrpc":"2.0","method":method,"params":params,"id":idv}
    async with httpx.AsyncClient(timeout=30.0) as client:
        r = await client.post(RPC, json=payload)
        r.raise_for_status()
        j = r.json()
        if "error" in j:
            raise RuntimeError(j["error"].get("message","rpc error"))
        return j["result"]

class ReceiptIn(BaseModel):
    tx_hash: str

@router.post("/receipt")
async def receipt(body: ReceiptIn):
    txh = body.tx_hash
    if not _is_hexhash(txh):
        raise HTTPException(400, "tx_hash must be 0x + 64 hex chars")

    rcpt = await _rpc("eth_getTransactionReceipt", [txh])
    if rcpt is None:
        return {"ok": True, "found": False, "tx_hash": txh}

    to_addr = (rcpt.get("to") or "").lower()
    if to_addr and (to_addr not in ALLOW_TO):
        raise HTTPException(403, f"receipt to-address not allowed: {to_addr}")

    # Best-effort decode ERC20 Transfer event from logs
    transfers = []
    for lg in (rcpt.get("logs") or []):
        if (lg.get("address","").lower() != to_addr):
            continue
        topics = lg.get("topics") or []
        # Transfer(address,address,uint256) topic0
        if len(topics) >= 3 and (topics[0].lower() == "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"):
            frm = "0x" + topics[1][-40:]
            to  = "0x" + topics[2][-40:]
            data = lg.get("data","0x0")
            transfers.append({"from": frm, "to": to, "value_hex": data})

    return {
        "ok": True,
        "found": True,
        "status": rcpt.get("status"),
        "from": rcpt.get("from"),
        "to": rcpt.get("to"),
        "blockNumber": rcpt.get("blockNumber"),
        "gasUsed": rcpt.get("gasUsed"),
        "effectiveGasPrice": rcpt.get("effectiveGasPrice"),
        "transfers": transfers,
        "tx_hash": txh,
    }
